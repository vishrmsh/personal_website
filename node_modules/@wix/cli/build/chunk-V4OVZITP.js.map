{"version":3,"sources":["../../cli-site-old/src/velo-npm/any-npm-migration.ts","../../cli-site-old/src/files/package-json.ts","../../cli-site-old/src/files/velo.dependencies.ts","../../cli-site-old/src/velo-npm/client.ts","../../cli-site-old/src/files/wix.lock.ts","../../cli-site-old/src/velo-npm/package-manager.ts","../../cli-site-old/src/velo-npm/index.ts"],"sourcesContent":["import { getVeloDependenciesConfigPath } from '@wix/cli-site-old-definitions';\nimport { pathExists } from '@wix/cli-fs';\nimport { unlink } from 'node:fs/promises';\nimport { addDependenciesToPackageJson } from '../files/package-json.js';\nimport { loadDependenciesConfig } from '../files/velo.dependencies.js';\nimport type { Logger } from '../logger.js';\n\nexport const migrateToAnyNpmIfNeeded = async (root: string, logger: Logger) => {\n  const oldDependenciesFilePath = getVeloDependenciesConfigPath(root);\n  if (await pathExists(oldDependenciesFilePath)) {\n    try {\n      logger.logMigratingToAnyNpm();\n\n      const oldVeloDeps = await loadDependenciesConfig(root);\n      await addDependenciesToPackageJson(root, oldVeloDeps);\n      await unlink(oldDependenciesFilePath);\n\n      logger.logMigrationToAnyNpmCompletedSuccessfully();\n    } catch (ex: unknown) {\n      logger.logMigrationToAnyNpmFailed();\n      throw ex;\n    }\n  }\n};\n","import { join } from 'node:path';\nimport type { PackageJson } from 'type-fest';\nimport { readJson, writeJson } from '@wix/cli-fs';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\n\nexport async function getDependencies(projectFolder: string) {\n  const packageJsonPath = join(projectFolder, 'package.json');\n  const packageJson = (await readJson(packageJsonPath)) as PackageJson;\n  return Object.entries(packageJson.dependencies ?? {}).map(\n    ([name, version]) => ({ name, version })\n  );\n}\n\nexport async function addDependenciesToPackageJson(\n  projectFolder: string,\n  dependenciesConfig: {\n    dependencies: Record<string, string>;\n  }\n) {\n  const packageJsonPath = join(projectFolder, 'package.json');\n  const packageJson = (await readJson(packageJsonPath)) as PackageJson;\n\n  if (\n    packageJson.dependencies &&\n    Object.keys(packageJson.dependencies).length > 0\n  ) {\n    throw new CliError({\n      code: CliErrorCode.FailedMigrationToAnyNpm(),\n      cause: null,\n    });\n  }\n\n  packageJson.dependencies = {};\n\n  for (const dependencyPackageName of Object.keys(\n    dependenciesConfig.dependencies\n  )) {\n    if (packageJson.devDependencies?.[dependencyPackageName]) {\n      delete packageJson.devDependencies[dependencyPackageName];\n    }\n\n    packageJson.dependencies[dependencyPackageName] =\n      dependenciesConfig.dependencies[dependencyPackageName];\n  }\n\n  await writeJson(packageJsonPath, packageJson);\n}\n","import {\n  veloDependenciesConfigSchema,\n  getVeloDependenciesConfigPath,\n  VELO_DEPENDENCIES_CONFIG_PATH,\n} from '@wix/cli-site-old-definitions';\nimport { readJson } from '@wix/cli-fs';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\n\nexport async function loadDependenciesConfig(projectFolder: string) {\n  const configFile = await readJson(\n    getVeloDependenciesConfigPath(projectFolder)\n  );\n\n  try {\n    return veloDependenciesConfigSchema.parse(configFile);\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.InvalidVeloConfigJson({\n        configFilename: VELO_DEPENDENCIES_CONFIG_PATH,\n      }),\n      cause: e,\n    });\n  }\n}\n","import {\n  resolveNpmDependencies as resolveNpmDependenciesRequest,\n  getResolveNpmDependenciesResult,\n} from '@wix/ambassador-velo-npm-v1-npm-package-info/http';\nimport pWaitFor from 'p-wait-for';\nimport type { AuthState } from '@wix/cli-auth';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\nimport { isHttpError } from '@wix/cli-http-client';\nimport { httpRequest } from '../http-request.js';\nimport { getDependencies } from '../files/package-json.js';\nimport { saveWixLock } from '../files/wix.lock.js';\nimport {\n  resolveNpmDependenciesSchema,\n  npmDependenciesLockFileResponseSchema,\n} from '../schemas.js';\n\ninterface RequestOptions {\n  authState: AuthState;\n}\n\nconst waitForInstallationCompleted = async (\n  jobId: string,\n  { authState }: RequestOptions\n) => {\n  try {\n    return await pWaitFor(\n      async () => {\n        try {\n          const { data } = await httpRequest(\n            { type: 'editor', authState },\n            getResolveNpmDependenciesResult({ jobId })\n          );\n\n          const npmDependenciesLockFileResponse =\n            npmDependenciesLockFileResponseSchema.parse(data);\n\n          return pWaitFor.resolveWith({\n            wixLockFileUrl:\n              npmDependenciesLockFileResponse.result.npmDependenciesLockFile,\n          });\n        } catch (e) {\n          // Continue polling\n          if (isHttpError(e) && e.response?.status === 428) {\n            return false;\n          }\n          // Unexpected error - stop polling\n          throw e;\n        }\n      },\n      {\n        // Poll each 3 seconds\n        interval: 3 * 1000,\n        // Fail if 2 minutes passed\n        timeout: 2 * 60 * 1000,\n      }\n    );\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToGetResolveNpmDependenciesResult(),\n      cause: e,\n      info: { jobId },\n    });\n  }\n};\n\nconst fetchAndSaveWixLock = async (url: string, root: string) => {\n  const wixLockContent = await httpRequest<string>(\n    { type: 'standalone' },\n    { url }\n  );\n  return saveWixLock(root, wixLockContent.data);\n};\n\nexport const resolveNpmDependencies = async (\n  root: string,\n  { authState }: RequestOptions\n) => {\n  try {\n    const npmPackageInfos = await getDependencies(root);\n\n    const { data: resolveNpmDependenciesResponse } = await httpRequest(\n      { type: 'editor', authState },\n      resolveNpmDependenciesRequest({ npmPackageInfos })\n    );\n\n    const { jobId } = resolveNpmDependenciesSchema.parse(\n      resolveNpmDependenciesResponse\n    );\n\n    const { wixLockFileUrl } = await waitForInstallationCompleted(jobId, {\n      authState,\n    });\n\n    await fetchAndSaveWixLock(wixLockFileUrl, root);\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToResolveNpmDependencies(),\n      cause: e,\n    });\n  }\n};\n","import { join } from 'node:path';\nimport { WIX_LOCK_FILENAME } from '@wix/cli-core-definitions';\nimport { outputFile } from '@wix/cli-fs';\nimport { CliError, CliErrorCode } from '@wix/cli-error';\n\nexport async function saveWixLock(\n  projectFolder: string,\n  lockFileContent: string\n) {\n  const wixLockPath = join(projectFolder, WIX_LOCK_FILENAME);\n  try {\n    await outputFile(wixLockPath, lockFileContent);\n  } catch (e) {\n    throw new CliError({\n      code: CliErrorCode.FailedToWriteWixLock(),\n      cause: e,\n    });\n  }\n}\n","import {\n  NPM,\n  Yarn,\n  getRepoType,\n  createPackageManager,\n} from '@wix/package-manager';\n\nexport async function resolvePackageManager(\n  projectFolder: string,\n  options: { yarn?: boolean; npm?: boolean }\n) {\n  const repoType = await getRepoType(projectFolder);\n  if (options.yarn) {\n    return new Yarn(repoType, 'yarn');\n  }\n\n  if (options.npm) {\n    return new NPM(repoType);\n  }\n\n  return createPackageManager(repoType);\n}\n","export { migrateToAnyNpmIfNeeded } from './any-npm-migration.js';\nexport { resolveNpmDependencies } from './client.js';\nexport { resolvePackageManager } from './package-manager.js';\n"],"mappings":"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","names":["join","join","resolveNpmDependencies"]}